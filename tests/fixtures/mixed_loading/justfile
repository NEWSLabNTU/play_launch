# Mixed Loading Test Suite

# Variables
ros_distro := env_var_or_default('ROS_DISTRO', 'humble')

# Show help
default:
    @just --list

# Run mixed loading test
run:
    #!/usr/bin/env bash
    set -e
    echo "Running mixed loading test (5 nodes â†’ 2 containers)..."
    echo "Expected: Sequential loading within each container, concurrent across containers"
    . /opt/ros/{{ros_distro}}/setup.bash
    . ../../../install/setup.bash
    play_launch launch launch/mixed.launch.xml

# Run with debug logs
run-debug:
    #!/usr/bin/env bash
    set -e
    echo "Running with debug logs..."
    . /opt/ros/{{ros_distro}}/setup.bash
    . ../../../install/setup.bash
    RUST_LOG=debug play_launch launch launch/mixed.launch.xml 2>&1 | grep -E "LoadNode|Starting load|container_[ab]"

# Check timing metrics
check-timing:
    #!/usr/bin/env bash
    set -e
    echo "=== Container A (Sequential) ==="
    for node in talker1 talker2 listener1; do
        timing_file="play_log/latest/load_node/$node/load_timing.csv"
        if [ -f "$timing_file" ]; then
            echo ""
            echo "Node: $node"
            cat "$timing_file"
        else
            echo "Node: $node - NO TIMING DATA"
        fi
    done

    echo ""
    echo "=== Container B (Sequential) ==="
    for node in talker3 listener2; do
        timing_file="play_log/latest/load_node/$node/load_timing.csv"
        if [ -f "$timing_file" ]; then
            echo ""
            echo "Node: $node"
            cat "$timing_file"
        else
            echo "Node: $node - NO TIMING DATA"
        fi
    done

    echo ""
    echo "=== Expected Pattern ==="
    echo "Within container_a: increasing queue_wait (talker1 < talker2 < listener1)"
    echo "Within container_b: increasing queue_wait (talker3 < listener2)"
    echo "Across containers: similar start times (concurrent execution)"

# Clean generated files
clean:
    #!/usr/bin/env bash
    set -e
    echo "Cleaning up..."
    rm -rf play_log record.json
    echo "Cleanup complete"
