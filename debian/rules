#!/usr/bin/make -f

export DH_VERBOSE = 1
export HOME = $(CURDIR)/debian/home

# Colcon flags (no --symlink-install for packaging - we need real files)
COLCON_FLAGS = --cmake-args -DCMAKE_BUILD_TYPE=Release --cargo-args --release

%:
	dh $@

override_dh_auto_configure:
	# Install Rust if needed
	if ! command -v rustc >/dev/null 2>&1; then \
		mkdir -p $(HOME)/.cargo; \
		curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path; \
	fi
	# Ensure rustup has a default toolchain
	export PATH="$(HOME)/.cargo/bin:$$PATH"; \
	if command -v rustup >/dev/null 2>&1; then \
		rustup default stable 2>/dev/null || true; \
	fi
	# Install colcon-cargo-ros2 and Python dependencies
	pip3 install --user --upgrade \
		colcon-cargo-ros2 \
		pyyaml lark packaging plotly pandas

override_dh_auto_build:
	export PATH="$(HOME)/.cargo/bin:$(HOME)/.local/bin:$$PATH"; \
	export PYTHONPATH="$(HOME)/.local/lib/python3.10/site-packages:$$PYTHONPATH"; \
	git submodule update --init --recursive; \
	. /opt/ros/humble/setup.sh && \
	colcon build $(COLCON_FLAGS) --base-paths src

override_dh_auto_install:
	# Install to /opt/ros/humble for ROS2 integration
	mkdir -p debian/play-launch/opt/ros/humble
	cp -r install/* debian/play-launch/opt/ros/humble/

	# Move main binaries to /usr/bin for FHS compliance and user convenience
	mkdir -p debian/play-launch/usr/bin
	if [ -f debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch ]; then \
		mv debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch \
			debian/play-launch/usr/bin/play_launch; \
		ln -sf /usr/bin/play_launch \
			debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch; \
	fi
	if [ -f debian/play-launch/opt/ros/humble/dump_launch/lib/dump_launch/dump_launch ]; then \
		mv debian/play-launch/opt/ros/humble/dump_launch/lib/dump_launch/dump_launch \
			debian/play-launch/usr/bin/dump_launch; \
		ln -sf /usr/bin/dump_launch \
			debian/play-launch/opt/ros/humble/dump_launch/lib/dump_launch/dump_launch; \
	fi
	if [ -f debian/play-launch/opt/ros/humble/play_launch_analyzer/lib/play_launch_analyzer/play_launch_analyzer ]; then \
		mv debian/play-launch/opt/ros/humble/play_launch_analyzer/lib/play_launch_analyzer/play_launch_analyzer \
			debian/play-launch/usr/bin/play_launch_analyzer; \
		ln -sf /usr/bin/play_launch_analyzer \
			debian/play-launch/opt/ros/humble/play_launch_analyzer/lib/play_launch_analyzer/play_launch_analyzer; \
	fi

	# Move I/O helper to /usr/lib/play-launch
	mkdir -p debian/play-launch/usr/lib/play-launch
	if [ -f debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch_io_helper ]; then \
		mv debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch_io_helper \
			debian/play-launch/usr/lib/play-launch/play_launch_io_helper; \
		ln -sf /usr/lib/play-launch/play_launch_io_helper \
			debian/play-launch/opt/ros/humble/play_launch/lib/play_launch/play_launch_io_helper; \
	fi

	# Install documentation
	mkdir -p debian/play-launch/usr/share/doc/play-launch
	install -Dm644 README.md debian/play-launch/usr/share/doc/play-launch/README.md
	install -Dm644 CLAUDE.md debian/play-launch/usr/share/doc/play-launch/CLAUDE.md
	if [ -d docs ]; then \
		cp -r docs/* debian/play-launch/usr/share/doc/play-launch/ 2>/dev/null || true; \
	fi

	# Install examples
	if [ -d test ]; then \
		mkdir -p debian/play-launch/usr/share/play-launch/examples; \
		cp -r test/* debian/play-launch/usr/share/play-launch/examples/; \
	fi

override_dh_auto_clean:
	rm -rf build install log debian/home
	dh_auto_clean
