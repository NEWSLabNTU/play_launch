# Autoware Planning Simulator Test

This directory contains test scripts for `dump_launch` and `play_launch` with Autoware planning simulator.

## Setup

1. **Create the autoware symlink** pointing to your Autoware workspace:
   ```bash
   ln -s /path/to/your/autoware autoware
   ```

   The symlink should point to a built Autoware workspace containing `install/setup.bash`.

2. **Ensure you have the required map data**:
   ```bash
   # The script expects the sample map at:
   $HOME/autoware_map/sample-map-planning
   ```

3. **Systemd user services** are available for running Autoware as a managed service (no additional installation required):
   - Automatic process cleanup when stopping the service
   - Log management via journalctl
   - Service status monitoring
   - No orphan ROS nodes after stopping

## Directory Structure

```
test/autoware_planning_simulation/
├── justfile              # Main test automation
├── README.md             # This file
├── autoware              # Symlink to Autoware workspace
├── cyclonedds.xml        # CycloneDDS configuration
├── record.json           # Launch execution record (generated)
├── poses_config.yaml     # Test poses configuration
├── play_log/             # Execution logs and metrics (generated)
└── scripts/              # Utility scripts
    ├── start-sim.sh                # Start simulator as systemd service (calls start-sim-inner.sh)
    ├── start-sim-inner.sh          # Simulator execution logic (runs inside systemd)
    ├── start-demo.sh               # Start demo as systemd service (calls start-demo-inner.sh)
    ├── start-demo-inner.sh         # Demo execution logic (runs inside systemd)
    ├── test_autonomous_drive.py    # Autonomous driving test
    ├── plot_resource_usage.py      # Plot generation tool
    └── kill_orphan_nodes.sh        # Cleanup utility
```

## Usage

### Using justfile (Recommended)

```bash
# Show available recipes
just --list

# Start Autoware simulator as systemd service (with web UI)
just start-sim       # ✓ Simulator service started (Web UI: http://localhost:8080)

# Manage the simulator service
just stop-sim        # ✓ Simulator service stopped
just restart-sim     # ✓ Simulator service restarted
just status-sim      # Show detailed service status
just logs-sim        # Follow logs in real-time (Ctrl+C to exit)

# Run autonomous driving test (requires simulator running)
just drive

# Start complete demo (simulator + autonomous test) as systemd service
just start-demo      # ✓ Demo service started (Web UI: http://localhost:8080)

# Manage the demo service
just stop-demo       # ✓ Demo service stopped
just restart-demo    # ✓ Demo service restarted
just status-demo     # Show detailed service status
just logs-demo       # Follow logs in real-time (Ctrl+C to exit)

# Clean up orphan ROS nodes
just kill-orphans
```

The justfile automatically sources the Autoware environment from `autoware/install/setup.bash`.

### Launch Methods

Both launch methods run as systemd user services for reliable process management:

**`just start-sim`** - Simulator service (autoware-sim):
- Web UI enabled on port 8080 (accessible at http://0.0.0.0:8080)
- Resource monitoring enabled (--enable-monitoring)
- Automatic cleanup on service stop
- Log management via `just logs-sim`
- Service control via `just {stop,restart,status}-sim`

**`just start-demo`** - Demo service (autoware-demo):
- Runs simulator + autonomous driving test sequentially
- Web UI enabled on port 8080 (accessible at http://0.0.0.0:8080)
- Automatic cleanup on service stop
- Log management via `just logs-demo`
- Service control via `just {stop,restart,status}-demo`

Both methods automatically source the Autoware workspace and set CycloneDDS configuration.

### Using Scripts Directly

```bash
# Start simulator
bash scripts/start-sim.sh

# Run autonomous driving test (requires simulator running)
python3 scripts/test_autonomous_drive.py
```

## Files

- `justfile` - Build automation for Autoware tests
- `cyclonedds.xml` - CycloneDDS configuration for localhost-only communication
- `scripts/start-sim.sh` - Launches simulator as systemd service (calls start-sim-inner.sh)
- `scripts/start-sim-inner.sh` - Simulator execution logic (runs inside systemd)
- `scripts/start-demo.sh` - Launches demo as systemd service (calls start-demo-inner.sh)
- `scripts/start-demo-inner.sh` - Demo execution logic (simulator + test, runs inside systemd)
- `scripts/test_autonomous_drive.py` - Python script to automate autonomous driving test
- `scripts/plot_resource_usage.py` - Resource usage plotting tool
- `scripts/kill_orphan_nodes.sh` - Cleanup orphan ROS nodes
- `poses_config.yaml` - Validated poses for sample-map-planning
- `autoware` - Symlink to Autoware installation (you must create this)
- `record.json` - Generated by `dump_launch` (contains launch execution record)
- `play_log/` - Generated by `play_launch` (contains timestamped execution logs and metrics)

## Autonomous Driving Test

### Quick Start - Automated Demo

Run the complete demo sequence as a systemd service:

```bash
just start-demo
```

This will:
1. Start Autoware with `play_launch launch` (via systemd service)
2. Wait for system to be ready (~60s)
3. Set initial pose
4. Set goal pose
5. Engage autonomous mode
6. Monitor for 60 seconds
7. Keep simulator running (managed by systemd)

Manage the demo with:
- `just status-demo` - Check if demo is running
- `just logs-demo` - View real-time logs
- `just stop-demo` - Stop the demo service

### Manual Test (Step-by-step)

1. Start Autoware planning simulator:
   ```bash
   just start-sim
   ```
   This runs in the foreground with:
   - Web UI at http://localhost:8080
   - Resource monitoring enabled

2. Wait ~60 seconds for system to initialize

3. In another terminal, run the autonomous driving test:
   ```bash
   just drive
   ```

### Test Sequence Details

The autonomous driving test performs:

1. **Wait for Autoware** - Checks that critical topics are active:
   - `/map/vector_map`
   - `/api/operation_mode/state`
   - `/api/routing/state`

2. **Set Initial Pose** - Publishes to `/initialpose` topic to initialize localization

3. **Wait for Localization** - Waits 5s for localization to stabilize and checks:
   - `/tf` transforms
   - `/localization/kinematic_state`

4. **Set Route** - Calls `/api/routing/set_route_points` service

5. **Engage Autonomous** - Calls `/api/operation_mode/change_to_autonomous` service

6. **Monitor Progress** - Monitors vehicle state for specified duration

### Pose Configuration

Poses are loaded from `poses_config.yaml` in this directory.
These poses are validated for `sample-map-planning`.

## Troubleshooting

### Error: 'autoware' symlink not found
Create the symlink:
```bash
ln -s /path/to/autoware autoware
```

### Error: symlink points to non-existent directory
Update the symlink to point to a valid Autoware installation:
```bash
ln -sf /path/to/autoware autoware
```

### Error: Autoware installation appears to be incomplete
Ensure the symlink points to a built Autoware workspace that contains `install/setup.bash`:
```bash
ls -la autoware/install/setup.bash
```

## Configuration

### justfile Variables

You can override these variables using environment variables:

```bash
MAP_PATH=/path/to/map just start-sim
```

Available variables:
- `MAP_PATH` - Path to map data (default: `$HOME/autoware_map/sample-map-planning`)
- `SERVICE_TIMEOUT` - Container service timeout in seconds (default: 300)
- `LOAD_TIMEOUT` - Node load timeout in milliseconds (default: 60000)

### play_launch Flags

The following flags are used for Autoware testing:

- `--wait-for-service-ready` - Enable container service readiness checking via ROS service discovery
- `--service-ready-timeout-secs 300` - Wait up to 5 minutes for each container service to be ready
- `--load-node-timeout-millis 60000` - Wait up to 60 seconds for each composable node to load

These conservative timeouts are appropriate for Autoware's large number of containers and composable nodes, where DDS initialization can take significant time.

## Comparison Testing

To test different modes:

```bash
# Test simulator only (foreground with web UI)
just start-sim

# Test complete demo (systemd service, automated sequence)
just start-demo

# Manage demo service
just logs-demo     # View demo logs
just status-demo   # Check demo status
just stop-demo     # Stop demo service
```

All methods use the same:
- Autoware workspace (`autoware/`)
- Map path configuration
- CycloneDDS settings (`cyclonedds.xml`)

This allows you to verify that different launch methods produce equivalent behavior.

### DDS Configuration

All launch methods use `cyclonedds.xml` which configures:
- Localhost-only communication (loopback interface)
- 65.5KB max message size
- 10MB socket buffer size

The `CYCLONEDDS_URI` environment variable is set before launching to ensure all nodes use this configuration.

### Systemd Service Details

Both `just start-sim` and `just start-demo` run as systemd user services:
- Runs as user service (no sudo required)
- Automatically sources `autoware/install/setup.bash`
- Sets `CYCLONEDDS_URI` environment variable
- Copies `DISPLAY` environment variable for GUI applications
- Can be managed with standard systemd commands:
  ```bash
  # Simulator service
  systemctl --user status autoware-sim
  journalctl --user -u autoware-sim -f
  systemctl --user stop autoware-sim

  # Demo service (simulator + autonomous test)
  systemctl --user status autoware-demo
  journalctl --user -u autoware-demo -f
  systemctl --user stop autoware-demo
  ```

The justfile recipes provide convenient wrappers:
- Simulator: `just {status,logs,restart,stop}-sim`
- Demo: `just {status,logs,restart,stop}-demo`
