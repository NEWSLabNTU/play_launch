# Autoware Planning Simulator Test

# Default recipe (show help)
default:
    @just --list

# Variables
script_dir := justfile_directory()
autoware_link := script_dir / "autoware"
map_path := env_var_or_default('MAP_PATH', env_var('HOME') / 'autoware_map/sample-map-planning')

# Verify Autoware installation
check-autoware:
    #!/usr/bin/env bash
    set -e
    if [ ! -L "{{autoware_link}}" ]; then
        echo "ERROR: 'autoware' symlink not found"
        echo "Create symlink: ln -s /path/to/autoware autoware"
        exit 1
    fi
    AUTOWARE_PATH=$(readlink -f "{{autoware_link}}" 2>/dev/null)
    if [ -z "$AUTOWARE_PATH" ] || [ ! -d "$AUTOWARE_PATH" ]; then
        echo "ERROR: autoware symlink points to invalid path"
        exit 1
    fi
    if [ ! -f "$AUTOWARE_PATH/install/setup.bash" ]; then
        echo "ERROR: install/setup.bash not found"
        exit 1
    fi

# Launch Autoware simulator (foreground, Ctrl-C to stop)
launch-sim: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"

    if [ ! -f "$SCRIPT_DIR/cyclonedds.xml" ]; then
        echo "ERROR: CycloneDDS configuration file not found at $SCRIPT_DIR/cyclonedds.xml"
        exit 1
    fi

    # Source ROS and Autoware setup
    source ../../install/setup.bash
    source autoware/install/setup.bash
    export CYCLONEDDS_URI="file://$SCRIPT_DIR/cyclonedds.xml"

# View logs from simulator service
logs-sim:
    @journalctl --user -u {{sim_service_name}} -n 100 -f

# Start Autoware demo service (simulator + autonomous test)
start-demo: check-autoware
    @MAP_PATH={{map_path}} ./scripts/start-demo.sh 2>&1 | tail -1

# Launch Autoware demo (simulator + autonomous test using GNU Parallel)
launch-demo: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"
    AUTOWARE_PATH=$(readlink -f autoware)

    if [ ! -f "$SCRIPT_DIR/cyclonedds.xml" ]; then
        echo "ERROR: CycloneDDS configuration file not found at $SCRIPT_DIR/cyclonedds.xml"
        exit 1
    fi

    # Check for GNU Parallel
    if ! command -v parallel &> /dev/null; then
        echo "ERROR: GNU Parallel not found. Install with: sudo apt install parallel"
        exit 1
    fi

    # Source ROS and Autoware setup
    source "$AUTOWARE_PATH/install/setup.bash"
    source "$SCRIPT_DIR/../../install/setup.bash"
    export CYCLONEDDS_URI="file://$SCRIPT_DIR/cyclonedds.xml"

# Run autonomous driving test (requires simulator running)
drive: check-autoware
    #!/usr/bin/env bash
    set -e
    AUTOWARE_PATH=$(readlink -f "{{autoware_link}}")
    cd "$AUTOWARE_PATH/install" && source setup.bash 2>&1 >/dev/null && cd "{{script_dir}}" && \
    python3 scripts/test_autonomous_drive.py

# Generate resource usage plots from latest play_log
plot:
    @play_launch plot

# Kill orphan ROS nodes
kill-orphans:
    @./scripts/kill_orphan_nodes.sh
