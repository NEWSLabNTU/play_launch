# Autoware Planning Simulator Test

# Default recipe (show help)
default:
    @just --list

# Variables
script_dir := justfile_directory()
autoware_link := script_dir / "autoware"
map_path := env_var_or_default('MAP_PATH', env_var('HOME') / 'autoware_map/sample-map-planning')

# Verify Autoware installation
check-autoware:
    #!/usr/bin/env bash
    set -e
    if [ ! -L "{{autoware_link}}" ]; then
        echo "ERROR: 'autoware' symlink not found"
        echo "Create symlink: ln -s /path/to/autoware autoware"
        exit 1
    fi
    AUTOWARE_PATH=$(readlink -f "{{autoware_link}}" 2>/dev/null)
    if [ -z "$AUTOWARE_PATH" ] || [ ! -d "$AUTOWARE_PATH" ]; then
        echo "ERROR: autoware symlink points to invalid path"
        exit 1
    fi
    if [ ! -f "$AUTOWARE_PATH/install/setup.bash" ]; then
        echo "ERROR: install/setup.bash not found"
        exit 1
    fi

# Run Autoware simulator with play_launch (foreground, Ctrl-C to stop)
run-sim: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"

    if [ ! -f "$SCRIPT_DIR/cyclonedds.xml" ]; then
        echo "ERROR: CycloneDDS configuration file not found at $SCRIPT_DIR/cyclonedds.xml"
        exit 1
    fi

    # Source ROS and Autoware setup
    source ../../install/setup.bash
    source autoware/install/setup.bash
    export CYCLONEDDS_URI="file://$SCRIPT_DIR/cyclonedds.xml"

    # Run with play_launch
    play_launch launch \
        --web-addr 0.0.0.0:8080 \
        autoware_launch planning_simulator.launch.xml \
        map_path:="$MAP_PATH"

# Run Autoware demo (simulator + autonomous test) using GNU Parallel
run-demo: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"
    AUTOWARE_PATH=$(readlink -f autoware)

    if [ ! -f "$SCRIPT_DIR/cyclonedds.xml" ]; then
        echo "ERROR: CycloneDDS configuration file not found at $SCRIPT_DIR/cyclonedds.xml"
        exit 1
    fi

    # Check for GNU Parallel
    if ! command -v parallel &> /dev/null; then
        echo "ERROR: GNU Parallel not found. Install with: sudo apt install parallel"
        exit 1
    fi

    # Source ROS and Autoware setup
    source "$AUTOWARE_PATH/install/setup.bash"
    source "$SCRIPT_DIR/../../install/setup.bash"
    export CYCLONEDDS_URI="file://$SCRIPT_DIR/cyclonedds.xml"

    # Export variables for parallel to inherit
    export MAP_PATH
    export CYCLONEDDS_URI
    export SCRIPT_DIR

    # Run simulator and test in parallel
    # Simulator runs continuously, test waits 60s then runs
    parallel --line-buffer ::: \
        "play_launch launch --web-addr 0.0.0.0:8080 autoware_launch planning_simulator.launch.xml map_path:=\"$MAP_PATH\"" \
        "sleep 60 && python3 $SCRIPT_DIR/scripts/test_autonomous_drive.py && echo '[Demo] Test completed. Press Ctrl-C to stop simulator.'"

# Generate resource usage plots from latest play_log
plot:
    @play_launch plot

# Dump launch file using Rust parser
dump-rust: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"

    # Source ROS and Autoware setup
    source ../../install/setup.bash
    source autoware/install/setup.bash

    echo "Dumping with Rust parser..."
    play_launch dump --output record_rust.json launch \
        --parser rust \
        autoware_launch planning_simulator.launch.xml \
        map_path:="$MAP_PATH"

    echo "✓ Rust parser dump complete: record_rust.json"

# Dump launch file using Python parser
dump-python: check-autoware
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    MAP_PATH="{{map_path}}"

    # Source ROS and Autoware setup
    source ../../install/setup.bash
    source autoware/install/setup.bash

    echo "Dumping with Python parser..."
    play_launch dump --output record_python.json launch \
        --parser python \
        autoware_launch planning_simulator.launch.xml \
        map_path:="$MAP_PATH"

    echo "✓ Python parser dump complete: record_python.json"

# Dump with both parsers
dump-both: dump-rust dump-python

# Compare Rust and Python parser outputs
compare-dumps:
    #!/usr/bin/env bash
    set -e
    SCRIPT_DIR="{{script_dir}}"
    cd "$SCRIPT_DIR"

    if [ ! -f "record_rust.json" ]; then
        echo "ERROR: record_rust.json not found. Run 'just dump-rust' first."
        exit 1
    fi

    if [ ! -f "record_python.json" ]; then
        echo "ERROR: record_python.json not found. Run 'just dump-python' first."
        exit 1
    fi

    echo "Comparing Rust and Python parser outputs..."
    echo ""

    # Use the compare_records.py script from the repo root
    python3 ../../scripts/compare_records.py record_rust.json record_python.json

    echo ""
    echo "Comparison complete."

# Kill orphan ROS nodes
kill-orphans:
    @./scripts/kill_orphan_nodes.sh
