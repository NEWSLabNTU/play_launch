# Autoware Planning Simulator Test

# Default recipe (show help)
default:
    @just --list

# Variables
script_dir := justfile_directory()
autoware_link := script_dir / "autoware"
map_path := env_var_or_default('MAP_PATH', env_var('HOME') / 'autoware_map/sample-map-planning')
sim_service_name := "autoware-sim"
demo_service_name := "autoware-demo"

# Verify Autoware installation
check-autoware:
    #!/usr/bin/env bash
    set -e
    if [ ! -L "{{autoware_link}}" ]; then
        echo "ERROR: 'autoware' symlink not found"
        echo "Create symlink: ln -s /path/to/autoware autoware"
        exit 1
    fi
    AUTOWARE_PATH=$(readlink -f "{{autoware_link}}" 2>/dev/null)
    if [ -z "$AUTOWARE_PATH" ] || [ ! -d "$AUTOWARE_PATH" ]; then
        echo "ERROR: autoware symlink points to invalid path"
        exit 1
    fi
    if [ ! -f "$AUTOWARE_PATH/install/setup.bash" ]; then
        echo "ERROR: install/setup.bash not found"
        exit 1
    fi

# Start Autoware simulator service
start-sim: check-autoware
    @MAP_PATH={{map_path}} ./scripts/start-sim.sh 2>&1 | tail -1

# Stop Autoware simulator service
stop-sim:
    @systemctl --user stop {{sim_service_name}} 2>&1 && echo "✓ Simulator service stopped" || echo "⚠ Service not running"

# Restart Autoware simulator service
restart-sim: check-autoware
    #!/usr/bin/env bash
    if systemctl --user is-active {{sim_service_name}} >/dev/null 2>&1; then
        systemctl --user restart {{sim_service_name}} 2>&1 >/dev/null && echo "✓ Simulator service restarted" || echo "✗ Failed to restart service"
    else
        MAP_PATH={{map_path}} ./scripts/start-sim.sh 2>&1 | tail -1
    fi

# Show status of simulator service
status-sim:
    @systemctl --user status {{sim_service_name}}

# View logs from simulator service
logs-sim:
    @journalctl --user -u {{sim_service_name}} -n 100 -f

# Start Autoware demo service (simulator + autonomous test)
start-demo: check-autoware
    @MAP_PATH={{map_path}} ./scripts/start-demo.sh 2>&1 | tail -1

# Stop Autoware demo service
stop-demo:
    @systemctl --user stop {{demo_service_name}} 2>&1 && echo "✓ Demo service stopped" || echo "⚠ Service not running"

# Restart Autoware demo service
restart-demo: check-autoware
    #!/usr/bin/env bash
    if systemctl --user is-active {{demo_service_name}} >/dev/null 2>&1; then
        systemctl --user restart {{demo_service_name}} 2>&1 >/dev/null && echo "✓ Demo service restarted" || echo "✗ Failed to restart service"
    else
        MAP_PATH={{map_path}} ./scripts/start-demo.sh 2>&1 | tail -1
    fi

# Show status of demo service
status-demo:
    @systemctl --user status {{demo_service_name}}

# View logs from demo service
logs-demo:
    @journalctl --user -u {{demo_service_name}} -n 100 -f

# Run autonomous driving test (requires simulator running)
drive: check-autoware
    #!/usr/bin/env bash
    set -e
    AUTOWARE_PATH=$(readlink -f "{{autoware_link}}")
    cd "$AUTOWARE_PATH/install" && source setup.bash 2>&1 >/dev/null && cd "{{script_dir}}" && \
    python3 scripts/test_autonomous_drive.py

# Generate resource usage plots from latest play_log
plot:
    @play_launch plot

# Kill orphan ROS nodes
kill-orphans:
    @./scripts/kill_orphan_nodes.sh
