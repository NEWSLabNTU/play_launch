# ROS Composition Demo Test

# Use bash for ROS setup scripts
set shell := ["bash", "-c"]

# Show help
help:
    @echo "ROS Composition Demo Test"
    @echo ""
    @echo "Recipes:"
    @echo "  test-all              - Run all tests (record + replay + verify)"
    @echo "  test-record           - Record composition_demo.launch.py"
    @echo "  test-replay           - Replay with service-based loading"
    @echo "  test-replay-standalone - Replay in standalone mode"
    @echo "  test-verify           - Verify the replay worked"
    @echo "  clean                 - Clean generated files"
    @echo ""

# Run all tests (record + replay + verify)
test-all: clean test-record test-replay test-verify
    @echo ""
    @echo "‚úÖ All tests completed!"

# Record composition_demo.launch.py
test-record:
    @echo "üìù Recording composition demo..."
    @. /opt/ros/humble/setup.bash && \
    . ../../install/setup.bash && \
    play_launch dump launch composition composition_demo.launch.py
    @echo "‚úÖ Recording complete: record.json created"
    @echo ""

# Replay with service-based component loading
test-replay:
    @echo "‚ñ∂Ô∏è  Replaying with service-based component loading..."
    @. /opt/ros/humble/setup.bash && \
    . ../../install/setup.bash && \
    timeout 20 play_launch replay || true
    @echo "‚úÖ Replay complete (timed out after 20s as expected)"
    @echo ""

# Replay in standalone mode
test-replay-standalone:
    @echo "‚ñ∂Ô∏è  Replaying in standalone mode..."
    @rm -rf play_log_standalone record_standalone.json
    @cp record.json record_standalone.json
    @. /opt/ros/humble/setup.bash && \
    . ../../install/setup.bash && \
    timeout 5 play_launch replay \
        --config record_standalone.json \
        --standalone-composable-nodes || true
    @echo "‚úÖ Standalone replay complete"
    @echo ""

# Verify the replay worked
test-verify:
    @echo "üîç Verifying replay results..."
    @./scripts/verify_replay.sh

# Clean generated files
clean:
    @echo "üßπ Cleaning up..."
    @rm -rf record.json record_standalone.json play_log play_log_standalone
    @echo "‚úÖ Cleanup complete"
